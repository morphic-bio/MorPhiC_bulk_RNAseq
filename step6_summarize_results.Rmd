---
title: "Summerize results"
author: "Si Liu, Wei Sun"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: journal
    highlight: tango
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: false
    number_sections: false
  df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R libraries.

```{r load_libraries, warning = FALSE, message = FALSE}
library(data.table)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(stringr)
library(cowplot)
library(dplyr)
library(RColorBrewer)

library(tidyr)
theme_set(theme_classic())
```

## Read in DE results

```{r}
releases_all = list.files("results", pattern = "JAX")
releases_all

DE_gene_list = list()

release = gene = nGenes = nDE_05 = nDE_01 = NULL

for(r1 in releases_all){
  fnms = list.files(file.path("results", r1, "processed"), full.names = TRUE)
  
  for(f1 in fnms){
    d1 = fread(f1)
    g1 = str_extract(f1, "(?<=_)[A-Za-z0-9]+(?=_DEseq2)")
    col_nm = paste0(g1, "_PTC_padj")
    
    if(g1 == "nor"){
      if(grepl("EPAS1_PTC_hyp_vs_nor", basename(f1))){
        g1 = "EPAS1_hyp_vs_nor"
        col_nm = "hyp_vs_nor_padj"
      }else if(grepl("EPAS1_reverted_hyp_vs_nor", basename(f1))){
        g1 = "EPAS1_reverted_hyp_vs_nor"
        col_nm = "hyp_vs_nor_padj"
      }else{
        print(paste("skip", basename(f1)))
        next
      }
    }else{
      if(grepl("reverted_", basename(f1))){
        g1 = paste0(g1, "_reverted")
        col_nm = paste0(g1, "_padj")
      }
    }
    
    if(grepl("Diverse", basename(f1))){
      g1 = paste0(g1, "_Diverse")
    }
    
    if(grepl("EPAS1", g1) && (! grepl("hyp_vs_nor", g1))){
      if(grepl("_hyp_", basename(f1))){
        g1 = paste0(g1, "_hyp")
      }else if(grepl("_nor_", basename(f1))){
        g1 = paste0(g1, "_nor")
      }else{
        stop("unexpected. EPAS1 should have condition hyp or nor")
      }
    }
    
    if(grepl("Neuroectoderm_CBO_day_", basename(f1))){
      g1 = paste0(g1, str_extract(basename(f1), "_day_\\d+"))
    }
    
    stopifnot(col_nm %in% names(d1))
    
    release = c(release, r1)
    gene   = c(gene, g1)
    nGenes = c(nGenes, nrow(d1))
    nDE_05 = c(nDE_05, sum(d1[[col_nm]] < 0.05, na.rm = TRUE))
    
    col2 = gsub("_padj", "_log2FoldChange", col_nm, fixed = TRUE)
    stopifnot(col2 %in% names(d1))

    nDE_01 = c(nDE_01, sum(d1[[col_nm]] < 0.01 & abs(d1[[col2]]) > 0.585, 
                           na.rm = TRUE))
    
    DE_gene_list[[g1]] = 
      d1$gene_ID[d1[[col_nm]] < 0.01 & abs(d1[[col2]]) > 0.585]
  }
}

df1 = data.frame(release, gene, nGenes, nDE_05, nDE_01)
```

## Summerize DE results
```{r fig.width = 7, fig.height = 4}
sort(table(df1$gene), decreasing = TRUE)[1:5]
df1 = df1[order(df1$gene),]
dim(df1)
df1[1:2,]

df1 <- df1 %>%
  mutate(base_gene = sub("_.*", "", gene))

df1 <- df1 %>%
  group_by(base_gene) %>%
  mutate(max_nDE_01 = max(nDE_01)) %>%
  ungroup()
dim(df1)
df1[1:2,]

t1 = table(df1$base_gene)
length(t1)
sort(t1, decreasing = TRUE)[1:10]

de_g0 = df1[df1$max_nDE_01 <= 5,]

de_g1 = df1[df1$nDE_01 > 5 & df1$max_nDE_01 < 1000,]
de_g2 = df1[df1$max_nDE_01 >= 1000,]
dim(de_g0)
dim(de_g1)
dim(de_g2)

de_g0

ggplot(de_g1, aes(x = nDE_05, y = nDE_01, color = release, 
                  label = gene)) +
  geom_point(size = 2) + 
  geom_text_repel(show.legend = FALSE) 

ggplot(de_g2, aes(x = nDE_05, y = nDE_01, color = release, 
                  label = gene)) +
  geom_point(size = 2) + 
  geom_text_repel(show.legend = FALSE) 

```

## Barplot
```{r fig.width = 6, fig.height = 3.8}

num_colors = length(unique(de_g1$base_gene))  # Number of unique base genes
num_colors

num_colors = length(unique(de_g2$base_gene))  # Number of unique base genes
num_colors

# Generate colors from YlOrRd and PuBuGn, then concatenate
color1 = colorRampPalette(brewer.pal(11, "RdYlBu"))(11)
color2 = colorRampPalette(brewer.pal(11, "PRGn"))(11)
set.seed(111)
combined_colors = sample(c(color1, color2))

ggplot(de_g1, aes(x = nDE_01, y = reorder(gene, max_nDE_01 + 1e-6*nDE_01), 
                  fill = base_gene)) +
  geom_bar(stat = "identity", color = "royalblue4", width = 0.8) + 
  labs(x = "# of DE genes", y="") + theme(legend.position = "none") + 
  scale_fill_manual(values = combined_colors)
```

```{r fig.width = 6, fig.height = 3.7}
de_g2 <- de_g2 %>%
  mutate(base_gene = sub("_.*", "", gene))

de_g2 <- de_g2 %>%
  group_by(base_gene) %>%
  mutate(max_nDE_01 = max(nDE_01)) %>%
  ungroup()

ggplot(de_g2, aes(x = nDE_01, y = reorder(gene, max_nDE_01 + 1e-6*nDE_01),
                  fill = base_gene)) +
  geom_bar(stat = "identity", color = "royalblue4", width = 0.8) + 
  labs(x = "# of DE genes", y="") + theme(legend.position = "none") + 
  scale_fill_manual(values = combined_colors)

```

## Write out results
```{r fig.width = 6, fig.height = 3}
fwrite(df1, "results/summary_DE_results.tsv", sep = "\t")
```

```{r}
gc()
sessionInfo()
```

